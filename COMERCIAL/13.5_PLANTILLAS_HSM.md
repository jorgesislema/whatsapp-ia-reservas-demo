# 13.5 Plantillas WhatsApp (HSM - Highly Structured Messages)

## Sobre HSM

**Â¿QuÃ© es HSM?**
- Mensajes pre-aprobados por Meta, enviables fuera del 24-hour window
- Permiten comunicaciÃ³n asincrÃ³nica (ej: recordatorios, cambios)
- Deben ser non-promotional, informativo/transaccional
- Requieren aprobaciÃ³n de Meta (2-24 horas tÃ­picamente)
- Idioma: Especificar al submeter (ej: ES_AR, ES, EN_US)
- Variables: Usar {{1}}, {{2}} para personalizacion

**Proceso:**
1. Definir plantilla con Meta Business Manager
2. Submeter con idioma + categorÃ­a
3. Esperar aprobaciÃ³n (status PENDING â†’ APPROVED/REJECTED)
4. Una vez APPROVED, usar vÃ­a API
5. Si REJECTED: Feedback de Meta, revisar & resubmeter

---

## ğŸ“‹ **PLANTILLAS RECOMENDADAS**

### 1ï¸âƒ£ ConfirmaciÃ³n de Reserva (CRITICA)

**Nombre (en Meta):** `reservation_confirmed`  
**CategorÃ­a (Meta):** TRANSACTIONAL  
**Idioma:** es_AR (o es_ES, en_US)  

**Estructura:**
```
Estimado {{1}},

âœ“ Tu reserva fue confirmada.

ğŸ“… Fecha: {{2}}
ğŸ• Hora: {{3}}
ğŸ‘¥ Personas: {{4}}

ğŸ“ {{5}}

NÃºmero confirmaciÃ³n: {{6}}
TelÃ©fono: {{7}}

Â¿Necesitas cambiar? Responde CAMBIAR.
Â¿Deseas cancelar? Responde CANCELAR.

Â¡Nos vemos pronto!
```

**Variables:**
1. `nombre_cliente` (ej: "Juan")
2. `fecha` (ej: "Viernes 10 de Enero")
3. `hora` (ej: "20:00")
4. `num_personas` (ej: "4")
5. `nombre_restaurante` (ej: "Resto La MarÃ­a - Centro")
6. `reserva_id` (ej: "RES-20250110-001")
7. `telefono` (ej: "+54 11 XXXX-XXXX")

**Ejemplos de rechazo Meta:**
- âŒ "PromociÃ³n especial" (prohibido mention promo en HSM)
- âŒ "Dale like a nuestro Instagram" (external links)
- âœ… "ConfirmaciÃ³n transaccional" (aceptado)

---

### 2ï¸âƒ£ Recordatorio 24h Antes (IMPORTANTE)

**Nombre:** `reservation_reminder_24h`  
**CategorÃ­a:** TRANSACTIONAL  

**Estructura:**
```
Hola {{1}},

Recordatorio: Tu reserva es maÃ±ana ğŸ‰

ğŸ“… {{2}}
ğŸ• {{3}}
ğŸ“ {{4}}

ConfirmaciÃ³n: {{5}}

Si no puedes llegar, avisa con anticipaciÃ³n.
Â¿Necesitas cambiar? Responde CAMBIAR.

Â¡Hasta maÃ±ana!
```

**Variables:**
1. `nombre_cliente`
2. `fecha` (ej: "Viernes 10 de Enero")
3. `hora`
4. `nombre_restaurante`
5. `reserva_id`

**Timing:** Enviado automÃ¡ticamente 24 horas antes

---

### 3ï¸âƒ£ Cambio/ActualizaciÃ³n de Reserva (IMPORTANTE)

**Nombre:** `reservation_changed`  
**CategorÃ­a:** TRANSACTIONAL  

**Estructura:**
```
Hola {{1}},

Tu reserva fue actualizada âœï¸

CAMBIOS:
{{2}}

Datos actualizados:
ğŸ“… {{3}}
ğŸ• {{4}}
ğŸ‘¥ {{5}}

Â¿Algo no es correcto? Responde AYUDA.

ConfirmaciÃ³n: {{6}}
```

**Variables:**
1. `nombre_cliente`
2. `cambios_resumen` (ej: "Hora de 19:00 a 20:00")
3. `fecha`
4. `hora`
5. `num_personas`
6. `reserva_id`

**Trigger:** Cuando cliente edita reserva vÃ­a panel/WhatsApp

---

### 4ï¸âƒ£ Cierre Especial/Feriado (IMPORTANTE)

**Nombre:** `closed_holiday_notification`  
**CategorÃ­a:** TRANSACTIONAL  

**Estructura:**
```
Hola {{1}},

Aviso importante âš ï¸

{{2}} estarÃ¡ {{3}}.

{{4}}

Nos vemos cuando reabramos:
ğŸ“… {{5}}
ğŸ• A las {{6}}

Â¿Preguntas? Responde AYUDA.
```

**Variables:**
1. `nombre_cliente`
2. `nombre_restaurante`
3. `estado` (ej: "cerrado por Navidad", "con horario reducido")
4. `detalles_cierre` (ej: "Abierto solo 12-18hs", "Cerrado por reforma")
5. `fecha_reapertura`
6. `hora_reapertura`

**Trigger:** Antes de entrar en vigencia excepciÃ³n

---

### 5ï¸âƒ£ Seguimiento Post-Reserva (OPCIONAL)

**Nombre:** `follow_up_post_reservation`  
**CategorÃ­a:** TRANSACTIONAL  

**Estructura:**
```
Â¡Muchas gracias {{1}}! ğŸ™

Esperamos te haya gustado tu visita a {{2}}.

ğŸ“ Â¿CÃ³mo estuvo tu experiencia?

Responde:
ğŸ˜Š Excelente
ğŸ‘Œ Bueno
ğŸ˜ Necesita mejorar

Tu feedback nos ayuda a mejorar.

ConfirmaciÃ³n: {{3}}
```

**Variables:**
1. `nombre_cliente`
2. `nombre_restaurante`
3. `reserva_id`

**Timing:** 2 horas despuÃ©s de checkout/fin de reserva

---

### 6ï¸âƒ£ PromociÃ³n Estacional (INFORMATIVA - Evitar si possible)

**Nombre:** `promotion_seasonal_info`  
**CategorÃ­a:** MARKETING (requiere opt-in cliente)  

**Estructura:**
```
Hola {{1}},

InformaciÃ³n especial de {{2}} ğŸ„

{{3}}

ğŸ“ {{4}}
ğŸ• {{5}}

MÃ¡s detalles: responde PROMO

ConfirmaciÃ³n: {{6}}
```

**Variables:**
1. `nombre_cliente`
2. `temporada` (ej: "Navidad", "AÃ±o Nuevo", "Verano")
3. `descripcion` (ej: "MenÃº especial disponible")
4. `nombre_restaurante`
5. `horarios` (ej: "9 al 31 de Diciembre")
6. `reserva_id`

âš ï¸ **Nota:** Meta rechaza HSM con lenguaje muy promotivo. Mantener informativo/value-focused.

---

## ğŸ¯ **MATRIZ DE PLANTILLAS A ENVIAR**

### Por Cliente Type

| Plantilla | BASE | PRO | ENTERPRISE | Obligatoria? |
|-----------|------|-----|------------|--------------|
| ConfirmaciÃ³n | âœ… | âœ… | âœ… | SÃ |
| Recordatorio 24h | âœ… | âœ… | âœ… | SÃ |
| Cambio/actualizaciÃ³n | âŒ | âœ… | âœ… | NO (pero recomendado) |
| Cierre/Feriado | âœ… | âœ… | âœ… | SÃ |
| Follow-up post | âŒ | âœ… | âœ… | NO |
| Promo estacional | âŒ | âŒ | âœ… | NO |

---

## ğŸ“¤ **PROCESO DE APROBACIÃ“N EN META**

### Step 1: Preparar Plantilla

En nuestro cÃ³digo (backend):

```python
# templates/whatsapp_hsm.py

TEMPLATES = {
    "reservation_confirmed": {
        "name": "reservation_confirmed",
        "language": "es_AR",  # Idioma
        "category": "TRANSACTIONAL",
        "body": """Estimado {{1}},

âœ“ Tu reserva fue confirmada.

ğŸ“… Fecha: {{2}}
ğŸ• Hora: {{3}}
ğŸ‘¥ Personas: {{4}}

ğŸ“ {{5}}

NÃºmero confirmaciÃ³n: {{6}}
TelÃ©fono: {{7}}

Â¿Necesitas cambiar? Responde CAMBIAR.
Â¿Deseas cancelar? Responde CANCELAR.

Â¡Nos vemos pronto!""",
        "variables": [
            {"name": "nombre_cliente", "type": "text"},
            {"name": "fecha", "type": "text"},
            {"name": "hora", "type": "text"},
            {"name": "num_personas", "type": "text"},
            {"name": "nombre_restaurante", "type": "text"},
            {"name": "reserva_id", "type": "text"},
            {"name": "telefono", "type": "text"},
        ]
    },
    # ... mÃ¡s templates
}
```

### Step 2: Submeter a Meta (via API)

```python
# PseudocÃ³digo - submeter plantilla

import requests

def submit_hsm_template(template_dict, client_token):
    url = f"https://graph.instagram.com/v18.0/{BUSINESS_ACCOUNT_ID}/message_templates"
    
    payload = {
        "name": template_dict["name"],
        "language": template_dict["language"],
        "category": template_dict["category"],
        "components": [
            {
                "type": "BODY",
                "text": template_dict["body"]
            }
        ]
    }
    
    response = requests.post(url, json=payload, headers={
        "Authorization": f"Bearer {client_token}"
    })
    
    if response.status_code == 200:
        template_id = response.json()["id"]
        print(f"âœ… Plantilla {template_dict['name']} subida")
        return template_id
    else:
        print(f"âŒ Error: {response.json()}")
        return None

# Usar:
for template_name, template_data in TEMPLATES.items():
    template_id = submit_hsm_template(template_data, client_token)
    # Guardar template_id en DB para referencia
```

### Step 3: Monitorear Status

```python
# Verificar status de plantilla

def check_template_status(template_name, client_token):
    url = f"https://graph.instagram.com/v18.0/{BUSINESS_ACCOUNT_ID}/message_templates?name={template_name}"
    
    response = requests.get(url, headers={
        "Authorization": f"Bearer {client_token}"
    })
    
    templates = response.json().get("data", [])
    for t in templates:
        print(f"Plantilla: {t['name']}")
        print(f"Status: {t['status']}")  # PENDING / APPROVED / REJECTED
        if t['status'] == "REJECTED":
            print(f"RazÃ³n: {t['rejection_reason']}")
    
    return templates

# Monitorear (tÃ­picamente 2-24 horas)
check_template_status("reservation_confirmed", client_token)
```

---

## ğŸ“§ **ENVÃO DE HSM (CODIGO)**

### Setup Inicial

```python
# Backend: usar HSM para comunicacion transaccional

class WhatsAppHSMManager:
    def __init__(self, wa_token, phone_id, business_account_id):
        self.wa_token = wa_token
        self.phone_id = phone_id
        self.api_url = f"https://graph.instagram.com/v18.0/{phone_id}/messages"
    
    def send_reservation_confirmed(self, phone_number, reservation_data):
        """EnvÃ­a HSM de confirmaciÃ³n con datos de reserva"""
        
        template_params = [
            reservation_data["customer_name"],      # {{1}}
            reservation_data["date"],                # {{2}}
            reservation_data["time"],                # {{3}}
            str(reservation_data["num_people"]),    # {{4}}
            reservation_data["restaurant_name"],    # {{5}}
            reservation_data["reservation_id"],     # {{6}}
            reservation_data["phone"],              # {{7}}
        ]
        
        payload = {
            "messaging_product": "whatsapp",
            "to": phone_number,
            "type": "template",
            "template": {
                "name": "reservation_confirmed",
                "language": {
                    "code": "es_AR"
                },
                "components": [
                    {
                        "type": "body",
                        "parameters": [
                            {"type": "text", "text": param}
                            for param in template_params
                        ]
                    }
                ]
            }
        }
        
        response = requests.post(
            self.api_url,
            json=payload,
            headers={"Authorization": f"Bearer {self.wa_token}"}
        )
        
        if response.status_code == 200:
            message_id = response.json()["messages"][0]["id"]
            print(f"âœ… HSM enviado: {message_id}")
            return message_id
        else:
            print(f"âŒ Error enviando HSM: {response.json()}")
            return None
    
    def send_reminder_24h(self, phone_number, reservation_data):
        """EnvÃ­a recordatorio 24 horas antes"""
        
        template_params = [
            reservation_data["customer_name"],
            reservation_data["date"],
            reservation_data["time"],
            reservation_data["restaurant_name"],
            reservation_data["reservation_id"],
        ]
        
        payload = {
            "messaging_product": "whatsapp",
            "to": phone_number,
            "type": "template",
            "template": {
                "name": "reservation_reminder_24h",
                "language": {"code": "es_AR"},
                "components": [
                    {
                        "type": "body",
                        "parameters": [
                            {"type": "text", "text": param}
                            for param in template_params
                        ]
                    }
                ]
            }
        }
        
        response = requests.post(
            self.api_url,
            json=payload,
            headers={"Authorization": f"Bearer {self.wa_token}"}
        )
        
        return response.status_code == 200

# Uso en Paso 12 (CI/CD):
hsm_manager = WhatsAppHSMManager(wa_token, phone_id, business_account_id)

# ConfirmaciÃ³n despuÃ©s de reserva
hsm_manager.send_reservation_confirmed(
    "+541112345678",
    {
        "customer_name": "Juan",
        "date": "Viernes 10 de Enero",
        "time": "20:00",
        "num_people": 4,
        "restaurant_name": "Resto La MarÃ­a",
        "reservation_id": "RES-20250110-001",
        "phone": "+54 11 XXXX-XXXX"
    }
)
```

---

## ğŸ”„ **SCHEDULER PARA REMINDERS**

```python
# En Paso 12 (OperaciÃ³n): Cron job para recordatorios

from celery import app
from datetime import datetime, timedelta

@app.task
def send_24h_reminders():
    """Ejecuta cada hora: busca reservas con 24h-1h para enviar reminder"""
    
    now = datetime.now()
    
    # Buscar reservas en prÃ³ximas 25 horas
    reservations = db.query(Reservation).filter(
        Reservation.datetime.between(
            now + timedelta(hours=23),
            now + timedelta(hours=25)
        ),
        Reservation.reminder_sent == False
    ).all()
    
    for res in reservations:
        try:
            hsm_manager.send_reminder_24h(
                res.customer_phone,
                {
                    "customer_name": res.customer_name,
                    "date": res.datetime.strftime("%A %d de %B"),
                    "time": res.datetime.strftime("%H:%M"),
                    "restaurant_name": res.restaurant.name,
                    "reservation_id": res.id,
                }
            )
            res.reminder_sent = True
            db.commit()
            print(f"âœ… Reminder sent: {res.id}")
        except Exception as e:
            print(f"âŒ Error sending reminder {res.id}: {e}")

# Celery beat schedule (en config):
CELERY_BEAT_SCHEDULE = {
    'send-24h-reminders': {
        'task': 'tasks.send_24h_reminders',
        'schedule': timedelta(hours=1),  # Ejecutar cada hora
    },
}
```

---

## âœ… **CHECKLIST DE TEMPLATES**

Antes de Go-Live:

- [ ] `reservation_confirmed` subida a Meta, status: âœ“ APPROVED
- [ ] `reservation_reminder_24h` subida, status: âœ“ APPROVED
- [ ] `closed_holiday_notification` subida, status: âœ“ APPROVED
- [ ] `reservation_changed` subida, status: âœ“ APPROVED (si PRO/Ent)
- [ ] `follow_up_post_reservation` subida, status: âœ“ APPROVED (si PRO/Ent)
- [ ] CÃ³digo backend: MÃ©todos send_*() implementados
- [ ] Scheduler: Cron para recordatorios configurado
- [ ] Testing: 5 mensajes de prueba enviados exitosamente
- [ ] Clientes notificados: "Usaremos HSM para comunicaciÃ³n"

---

## ğŸš¨ **TROUBLESHOOTING: RECHAZOS DE META**

### Error: "Template name already exists"
**SoluciÃ³n:** Cambiar nombre a `reservation_confirmed_v2` o `reservation_confirmed_es_ar_v1`

### Error: "Invalid language code"
**SoluciÃ³n:** 
- Usar `es_AR` (exactamente, con underscore)
- Alternativas: `es_ES`, `es_MX`, `en_US`
- Ver lista completa: https://developers.facebook.com/docs/whatsapp/message-templates/guidelines

### Error: "Template contains promotional content"
**SoluciÃ³n:** 
- Reemplazar "PromociÃ³n especial" â†’ "InformaciÃ³n especial"
- Reemplazar "Â¡Descuento!" â†’ "Oferta disponible"
- Evitar call-to-action agresivo

### Error: "Too many variables"
**SoluciÃ³n:** Max 4 variables por template. Si necesitas >4, combinar en 1:
```
{{2}} en lugar de {{2}} (Date) {{3}} (Time)
```

### PENDING por >24 horas
**SoluciÃ³n:** 
- Hacer pequeÃ±o cambio en plantilla (ej: agregar espacio)
- Resubmeter
- Si persiste, contactar Meta Support via Business Manager

---

## ğŸ“ **DOCUMENTACIÃ“N PARA CLIENTE**

Entregar al cliente:

```markdown
# Plantillas WhatsApp Activadas

Tu restaurante usarÃ¡ 4 plantillas automÃ¡ticas:

1. **ConfirmaciÃ³n de Reserva** 
   â†’ Enviado instantÃ¡neamente despuÃ©s de reserva
   
2. **Recordatorio 24h**
   â†’ Enviado automÃ¡ticamente 1 dÃ­a antes
   
3. **NotificaciÃ³n de Cambios**
   â†’ Si editaste horarios/cierre especial
   
4. **Seguimiento Post-Reserva** (PRO/Enterprise)
   â†’ 2 horas despuÃ©s para feedback

Estas plantillas fueron aprobadas por Meta y son transaccionales (no spam).
Cliente recibe info importante sin necesidad de chatear.

Â¿Preguntas? Contacta a support@[empresa].com
```

---

**Ãšltima actualizaciÃ³n:** 2025-01-02  
**VersiÃ³n:** 1.0  
**Estado:** âœ… Listo para deployment
